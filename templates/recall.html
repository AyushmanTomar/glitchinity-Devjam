<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MemorAI-Recall</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="shortcut icon" href="{{ url_for('static', filename='images/logo.png') }}" type="image/x-icon">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
    <div class="container">
        <aside class="sidebar">
            <div class="logo">
                <img src="{{ url_for('static', filename='images/logo.png') }}" alt="MemorAI Logo">
                <a href="/">
                    <h1>MemorAI</h1>
                </a>
            </div>
            <div class="new-memory-bar">
                <button class="new-memory" onclick="window.location.href='/update'">
                    <i class="fas fa-plus"></i> New Memory
                </button>
                <i class="fas fa-search search-icon"></i>
            </div>

            <div class="conversations">
                <p class="conversation-title">
                    Current Conversation
                    <span class="clear-all">Clear All</span>
                </p>
                <div class="conversation active">
                    <p>MemorAI Project...</p>
                    <div class="icons">
                        <i class="fas fa-pen"></i>
                        <i class="fas fa-trash"></i>
                    </div>
                </div>
                <p class="conversation-title">Last 7 Days</p>
                <ul class="conversation-list">
                    <li>Finance management</li>
                    <li>Operator Grammar Types</li>
                    <li>Min States For Binary DFA</li>
                    <li class="disabled">MemorAI POS system</li>
                </ul>
            </div>

            <!-- Footer with settings and user profile box -->
            <div class="footer">
                <div class="settings-box" onclick="window.location.href='/community'">
                    <i class="fas fa-users"></i>
                    <p>Community</p>
                </div>
                <div class="user-box">
                    <img src="" alt="User Image" class="user-profile-photo">
                    <p class="user-name">user</p>
                    <i class="fas fa-sign-out-alt" onclick="window.location.href='/logout'"></i>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <h2 class="left-aligned">Query your MemorAI</h2>
            <div class="chat-box">
                <div class="chat-textarea" id="chat-textarea" style="height: fit-content;">
                    <div class="message-box" id="message-box"></div>
                    <div class="bot-message" id="bot-message"></div>
                </div>
                <div id="loader-box" style="display: flex; justify-content: end; width: 100%; padding-right: 40px;">
                    <div class="loader">
                        <div>
                            <ul>
                                <li>
                                    <svg fill="currentColor" viewBox="0 0 90 120">
                                        <path
                                            d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z">
                                        </path>
                                    </svg>
                                </li>
                                <li>
                                    <svg fill="currentColor" viewBox="0 0 90 120">
                                        <path
                                            d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z">
                                        </path>
                                    </svg>
                                </li>
                                <li>
                                    <svg fill="currentColor" viewBox="0 0 90 120">
                                        <path
                                            d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z">
                                        </path>
                                    </svg>
                                </li>
                                <li>
                                    <svg fill="currentColor" viewBox="0 0 90 120">
                                        <path
                                            d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z">
                                        </path>
                                    </svg>
                                </li>
                                <li>
                                    <svg fill="currentColor" viewBox="0 0 90 120">
                                        <path
                                            d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z">
                                        </path>
                                    </svg>
                                </li>
                                <li>
                                    <svg fill="currentColor" viewBox="0 0 90 120">
                                        <path
                                            d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z">
                                        </path>
                                    </svg>
                                </li>
                            </ul>
                        </div><span>Thinking..</span>
                    </div>
                </div>

            </div>
            <div class="" style="display: flex; width: 100%; justify-content: space-around;">
                <form action="/recallmemory" id="updateform" method="post" style="width: 100%;">
                    <div class="message-input">
                        <input type="text" placeholder="What's on your mind?..." id="memory" name="memory">
                        <button class="send-button" type="submit"><i class="fas fa-paper-plane"></i></button>
                    </div>

                </form>
                <button id="post-btn" class="btn btn-danger btn-block"
                    style="width:65px;margin-right: 20px; border-radius: 50%; border: none; box-shadow: 2px 2px 2px rgba(0, 0, 0, 0.1); background-color: rgb(255, 47, 0); cursor: pointer;"><i
                        class="fa fa-upload"></i></button>
                <button id="start-btn" class="btn btn-danger btn-block"
                    style="width:100px; border-radius: 30px; border: none; box-shadow: 2px 2px 2px rgba(0, 0, 0, 0.1); background-color: rgb(80, 80, 254);"><img
                        src="{{url_for('static',filename='images/mic.png')}}" alt="" width="30px"></button>
            </div>
        </main>
    </div>
    <script>

        
        document.getElementById('loader-box').style.display = 'none'
        document.getElementById('message-box').style.display = 'none'
        document.getElementById('message-box').style.display = 'none'
        document.getElementById('bot-message').style.display = 'none'
        chat = []


        $(document).ready(function () {
            $('#updateform').on('submit', function (event) {
                event.preventDefault();
                const userInput = $('#memory').val();

                // Add user message to chat array
                chat.push({ type: 'user', message: userInput });


                // Display updated chat
                displayChat();
                document.getElementById('loader-box').style.display = 'flex'
                $.ajax({
                    url: '/recallmemory',
                    type: 'POST',
                    data: $(this).serialize(),
                    success: function (response) {
                        // Add response to chat array
                        chat.push({ type: 'bot', message: response.memory });
                        // Display updated chat
                        displayChat();
                        // Clear input field
                        $('#memory').val('');
                        document.getElementById('loader-box').style.display = 'none'
                    },
                    error: function (error) {
                        console.log('Error:', error);
                    }
                });
            });
        });

        function displayChat() {
            const messageBox = $('#chat-textarea');
            messageBox.empty(); // Clear existing messages
            chat.forEach(item => {
                let chatrow = $('<div>').addClass('chat-row');
                const messageElement = $('<div>').addClass('message');
                if (item.type === 'user') {
                    messageElement.addClass('message-box').text(item.message);
                } else {
                    messageElement.addClass('bot-message').text(item.message);
                }
                chatrow.append(messageElement)
                messageBox.append(chatrow);
            });

            // Show message box and scroll to bottom
            messageBox.show().scrollTop(messageBox[0].scrollHeight);
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3/build/jwt-decode.min.js"></script>
    <script>
        // Function to retrieve the cookie value
        function getCookie(name) {
            let nameEQ = name + "=";
            let cookiesArray = document.cookie.split(';');
            for (let i = 0; i < cookiesArray.length; i++) {
                let cookie = cookiesArray[i].trim();
                if (cookie.indexOf(nameEQ) == 0) {
                    return cookie.substring(nameEQ.length, cookie.length);
                }
            }
            return null;
        }

        // Function to decode JWT token
        function parseJWT(token) {
            let base64Url = token.split('.')[1]; // Get the payload part (second part of JWT)
            let base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/'); // Adjust for base64 URL encoding
            let jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));

            return JSON.parse(jsonPayload); // Return the decoded JSON object
        }

        // Retrieve the JWT from the cookie and decode it
        let jwtToken = getCookie('cookie'); // Replace 'cookie' with your actual cookie name
        console.log(jwtToken, "jwt");

        if (jwtToken) {
            let decodedToken = parseJWT(jwtToken);
            console.log(decodedToken); // Now you have the decoded JWT payload (claims)

            // Get the first element with the class 'user-profile-photo'
            let userProfileImg = document.getElementsByClassName('user-profile-photo')[0];

            // Ensure the element exists and is an <img> tag
            if (userProfileImg && userProfileImg.tagName === 'IMG') {
                // Set the src attribute to the decoded picture URL
                userProfileImg.src = decodedToken['picture'];
            } else {
                console.error("Element with class 'user-profile-photo' not found or is not an <img>.");
            }

            let username = document.getElementsByClassName('user-name')[0];
            if (username) {
                username.textContent = decodedToken['name']
            }
            else {
                console.error("Element username not found")
            }
        } else {
            console.error("JWT token not found in the cookie.");
        }


    </script>
    <script src="{{ url_for('static', filename='js/textspeech.js') }}"></script>
</body>

</html>